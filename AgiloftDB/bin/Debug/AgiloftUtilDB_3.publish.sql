/*
Deployment script for Agiloft

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "Agiloft"
:setvar DefaultFilePrefix "Agiloft"
:setvar DefaultDataPath "H:\DataMigration\DB\Data\"
:setvar DefaultLogPath "I:\DataMigration\DB\Transactions\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating [dbo].[ImportData]...';


GO
CREATE PROCEDURE [dbo].[ImportData]
AS
	TRUNCATE TABLE Employee

	INSERT INTO Employee
	SELECT *
	FROM OPENQUERY(EPM, '
			SELECT    E.NetID
								, E.FirstName
					  , E.LastName
					  , E.PreferredFirstName
								, E.PreferredLastName
								, E.Department
								, E.UNIT
								, E.PrimaryJobPosition
								, E.Email
								, E.OfficePhone
					  , E.MobilePhone
								, E.EmployeeStatus
					  , E.TerminationDate
					  , E.SupervisorNetID
				FROM (
					SELECT  	
					  E.NETID_OPRID NetID
								, E.FIRST_NAME FirstName
					  , E.LAST_NAME LastName
					  , E.PREF_FIRST_NAME PreferredFirstName
								, E.PREF_LAST_NAME PreferredLastName
								, J.DEPT_NAME Department
								, '''' UNIT
								, J.POSITION_LD PrimaryJobPosition
								, E.EMAIL_ADDR Email
								, REPLACE(REPLACE(E.WORK_PHONE, ''/'', ''''),''-'','''') OfficePhone
					  , '''' MobilePhone
								, E.EMPL_STAT_CD EmployeeStatus
					  , E.TERMINATION_DT TerminationDate
					  , Supv.NETID_OPRID SupervisorNetID
								, Row_Number() OVER (PARTITION BY J.EmplID ORDER BY CASE WHEN J.PRIMARY_JOB_INDC = ''1'' THEN 1 ELSE 2 END DESC) PosRank
					FROM  SYSADM.PS_UA_EMPL_PROF_PP E
					INNER JOIN SYSADM.PS_UA_EMPL_JOB_DTL J
					  ON E.EMPLID = J.EMPLID
					LEFT JOIN SYSADM.PS_UA_EMPL_PROF_PP Supv
						ON Supv.EmplID = E.SUPERVSR_EMPLID
						AND Supv.Day_SID = E.Day_SID
					WHERE E.DAY_SID = ''20180211'' --Previous sunday to payday  
					  AND J.Active_Job_Indc = ''A''
					  AND J.DEPTID IN (8801, 8802, 8804, 8810, 8814)
				) E
				WHERE E.PosRank = 1
	')

RETURN 0
GO
PRINT N'Update complete.';


GO
